# 小嘉智能环境监控系统 - 项目文档

## 目录

```
1. 项目概述
   1.1 项目背景
   1.2 项目目标

2. 需求分析
   2.1 功能需求
       2.1.1 消息发布模块
       2.1.2 数据订阅模块
       2.1.3 智能分析模块
   2.2 非功能需求
   2.3 用户界面需求
   2.4 接口需求

3. 系统设计
   3.1 系统架构设计
   3.2 模块设计
       3.2.1 UI框架设计
       3.2.2 发布模块设计
       3.2.3 订阅模块设计
       3.2.4 分析模块设计
   3.3 数据库设计
   3.4 接口设计

4. 核心算法设计
   4.1 消息发布模块
   4.2 数据订阅模块
   4.3 智能分析模块
  
5. 软件说明
   5.1 开发环境
   5.2 项目结构
   5.3 安装部署
   5.4 使用说明
   5.5 API文档

6. 附录
   6.1 参考资料
   6.2 团队分工
```

# 1. 项目概述

### 1.1 项目背景

在同济大学嘉定校区，环境舒适度对同学们的学习和生活有着直接的影响。然而，当前获取教学楼、图书馆等地方的温度、湿度等环境信息的方式却不够直观便捷，导致诸如“今天自习室是否闷热？”、“梅雨季节图书馆是否会返潮？”等问题得不到及时解答。这些环境监测数据通常以枯燥的数字形式呈现，缺乏与校园具体场景的有效结合，难以被广大学生快速理解和应用。

为了解决这一问题，我们开发了名为 **“小嘉”** 的环境数字助手。作为一款基于模拟传感器数据（包括温度、湿度、气压等）并通过 MQTT 协议实现数据发布与订阅的应用，“小嘉”致力于将环境数据转化为对学生日常生活有实际意义的信息。通过本地 GUI 界面进行数据可视化与智能解读，“小嘉”不仅能够展示实时的环境状况，还能根据特定模型分析出该环境下是否适宜学习或活动，并给出相应的建议。

不同于传统的数据看板，“小嘉”更注重用户体验与互动性，它能结合校园地图展示各个位置的具体环境条件，提供体感舒适度评估，并针对特殊事件（如高温预警、湿度过高等）主动推送温馨提醒，比如：“小嘉提醒：教学楼A栋当前体感舒适（25.3℃, 60%RH），适合自习！”、“小嘉提示：梅雨季节湿度偏高，请注意防潮。”等。这使得环境数据不仅仅是冰冷的数字，而是成为关心学生日常生活的贴心伙伴。

### 1.2 项目目标

“小嘉”的设计初衷是探索如何使环境数据更好地服务于校园生活，旨在创造一个既实用又富有情感的智慧校园解决方案。具体来说，我们的目标包括：

* **提升环境信息的可达性** ：利用MQTT协议实现实时数据的高效传输，确保学生可以随时访问最新的环境状况。
* **增强数据的理解性和实用性** ：通过构建舒适度评估模型，将抽象的数据转换成具体的建议，帮助用户判断某个地点是否适合作业或休息。
* **引入人性化交互元素** ：采用拟人化的设计理念，赋予系统个性化的形象——“小嘉”，使其能够像朋友一样向用户提供温暖且有用的提示。
* **促进校园社区的参与感** ：鼓励学生参与到智慧校园建设中来，通过反馈机制不断优化系统功能和服务质量，共同营造更加舒适和谐的学习生活环境。

综上所述，“小嘉”不仅仅是一个技术展示平台，更是连接校园环境与学生需求之间的桥梁，致力于让每一位使用者都能感受到来自科技的人文关怀。

# 2. 需求分析

本系统面向同济大学嘉定校区环境监控场景，旨在构建一个集数据发布、订阅、可视化与智能解读于一体的本地化桌面应用。系统以“小嘉”作为拟人化交互载体，强调易用性、实时性与校园情境感知。需求分为功能需求、非功能需求、用户界面需求及通信接口四部分。

### 2.1 功能需求

#### 2.1.1 消息发布模块

该模块允许用户模拟传感器或设备向 MQTT 服务器发送环境数据。用户可自由指定发布主题（如 `sensor/temperature/classroom_a`），并编辑符合 JSON 格式的有效载荷（如 `{"value": 25.6, "unit": "°C"}`）。系统支持一键发布，并自动记录历史操作以便回溯。此外，提供基础的发布统计信息（如总次数、成功数），并预留定时发布能力以支持未来自动化测试场景。

#### 2.1.2 数据订阅模块

作为系统的核心交互入口，订阅模块需支持用户订阅一个或多个 MQTT 主题，实时接收并解析来自模拟传感器的消息。所有接收到的数据将以结构化形式展示在消息面板中，并同步更新至可视化区域。特别地，每条消息若包含位置标识（如 `location: "教学楼A"`），系统将在界面中关联显示该位置信息，并与“小嘉”形象的状态联动——例如当温湿度处于舒适区间时，“小嘉”呈现绿色微笑状态；异常时则变为黄色或红色警示表情。

#### 2.1.3 智能分析模块

在基础数据展示之上，系统需提供轻量级但实用的智能分析能力：

- 通过仪表盘和折线图实时呈现温度、湿度等关键参数的变化趋势；
- 基于预设的舒适度模型计算当前环境舒适指数，并生成通俗易懂的建议语句（如“适合自习”或“建议通风”）；
- 支持对异常值（如突升的温度、持续高湿）进行检测并触发告警；
- 在时间维度上提供短期趋势预测（如未来5分钟变化方向），辅助用户预判环境变化。

### 2.2 非功能需求

系统需在普通笔记本电脑上流畅运行，满足以下质量属性：

- **性能**：界面操作响应时间不超过 100 毫秒，数据从接收到刷新延迟控制在 1 秒以内，内存占用不超过 500MB；
- **可靠性**：在正常网络条件下，系统应保持 99% 以上的可用性，MQTT 消息丢失率低于 0.1%；
- **兼容性**：支持 Windows 10 及以上、主流 Linux 发行版，Python 版本不低于 3.8；
- **安全性**：MQTT 连接支持用户名/密码认证，并可选启用 TLS 加密（端口 8883）以保障通信安全。

### 2.3 用户界面需求

界面设计遵循“深色工业风”美学，契合技术监控系统的专业感，同时融入亲和力元素：

- 采用深灰背景与青蓝色主色调，关键控件添加**发光边缘与渐变效果**（如标题栏、按钮）；
- 所有图表与数值变化需具备**平滑动画过渡**，避免视觉跳变；
- “小嘉”形象作为状态指示器，通过**颜色与表情变化**直观反映系统健康度与环境舒适度（绿色=良好，黄色=注意，红色=异常）；
- 界面需适配高 DPI 显示屏，确保在 2K/4K 屏幕下文字与图标清晰锐利。

### 2.4 MQTT 接口规范

系统通过标准 MQTT 协议（兼容 3.1.1 与 5.0）与消息代理通信。用户可配置服务器地址、端口（默认 1883，TLS 模式为 8883）、用户名及密码。所有发布与订阅操作均支持 QoS 0/1/2 级别，可根据数据重要性灵活选择。连接过程需具备断线重连机制，保障长时间运行的稳定性。

# 3. 系统设计

## 3.1 系统架构设计

### 3.1.1 整体架构图

本系统采用**分层架构 + 模块化设计**，整体划分为 **UI 层、业务逻辑层、核心通信层** 三个层次，各模块通过明确定义的接口交互，确保高内聚、低耦合。系统以 **PyQt5 构建的图形界面** 作为用户入口，通过 **MQTT 客户端** 与本地消息代理通信，实现模拟传感器数据的发布与订阅。

架构自上而下分为三层：

- **UI 层**：负责页面布局、用户交互、数据可视化；
- **业务逻辑层**：包含发布、订阅、分析三大功能模块，封装各自领域逻辑；
- **核心通信层**：提供统一的 MQTT 客户端封装，屏蔽底层协议细节。

<img src="assets/structure.png" title="" alt="" width="473">

### 3.2 模块详细设计

#### 3.2.1 UI 框架设计

系统主窗口继承自 `QMainWindow`，采用 **侧边栏导航 + 页面栈切换** 的模式，提升多页面管理效率。

- **BaseWindow**：定义通用窗口结构，包含标题栏、状态提示区，提供统一的状态消息接口（如“连接成功”“发布失败”）。
- **MainWindow**：实现具体导航逻辑，管理三个核心页面（发布页、订阅页、分析页），并监听 MQTT 连接状态以更新全局 UI（如连接指示灯）。
- **BasePage**：所有功能页面的基类，提供标准化的 UI 构建方法（如创建卡片网格、面板标题），并定义抽象方法 `init_ui()` 强制子类实现界面初始化。
- **组件库**：封装了可复用的 UI 元素，包括：
  - **数据卡片**（DataCard/MiniCard）：用于展示温度、湿度等数值及其状态；
  - **仪表盘组件**（GaugeWidget/DashboardGauge）：以环形或指针形式可视化关键指标；
  - **图表组件**（LineChart/BarChart）：支持实时数据绘图与动态更新。

该设计确保 UI 风格统一、代码复用率高，并便于未来扩展新页面。

#### 3.2.2 发布模块设计

发布模块允许用户手动构造并发送 MQTT 消息，主要用于模拟传感器行为或测试通信链路。

- **PublisherLogic**：核心逻辑类，封装 MQTT 发布操作。维护发布计数、成功率统计及历史记录（最多 100 条）。提供 `publish()` 方法，返回操作是否成功，并通过 `published` 信号通知 UI 更新结果。
- **PublishRecord**：轻量级数据结构，记录每次发布的主题、消息内容、时间戳、QoS 等信息，供历史查看使用。
- **交互流程**：用户在界面填写主题与 JSON 消息 → 点击“发布” → 调用 `PublisherLogic.publish()` → 若成功，MQTT 客户端发送 PUBLISH 报文 → 收到 PUBACK 后触发信号 → UI 显示绿色成功提示；失败则显示红色错误。

该模块支持基础统计与历史回溯，满足调试与演示需求。

#### 3.2.3 订阅模块设计

订阅模块负责监听指定 MQTT 主题，接收并解析环境数据，同时驱动“小嘉”形象与位置地图的动态反馈。

- **SubscriberLogic**：管理订阅生命周期，维护已订阅主题列表，缓存最近 N 条消息。通过 `message_received` 信号将原始 payload 传递给 UI。
- **LocationWidget**：自定义地图控件，内置嘉定校区关键建筑坐标（如教学楼 A、图书馆）。当接收到带 `location` 字段的消息时，自动高亮对应区域。
- **XiaojiaDisplay**：拟人化助手组件，根据当前环境舒适度动态切换表情与颜色：
  - **绿色/微笑**：舒适（如 24°C, 50%RH）；
  - **黄色/皱眉**：一般（偏热或偏湿）；
  - **红色/警觉**：异常（超出阈值）。
    同时支持“说话”功能，显示如“适合自习！”等提示语。

该模块将冷数据转化为有温度的校园情境反馈，是系统创新点的核心载体。

#### 3.2.4 分析模块设计

分析模块在订阅数据基础上，提供轻量级智能解读能力，无需外部模型或网络。

- **ComfortModel**：实现本地舒适度算法。采用简化公式：`comfort = 100 - |T - 24| × 3 - |H - 50| × 0.5`，输出 0–100 的舒适指数，并映射为“优/良/中/差”等级，同时生成建议（如“建议开启除湿”）。
- **EventContext**：基于预设阈值（如温度 >35°C 触发高温告警）检测异常事件。支持注册回调函数，在事件发生时触发 UI 告警（弹窗、声音、状态变红）。
- **Predictor**：提供三种短期趋势预测算法：
  - **简单移动平均**（SMA）：适用于平稳数据；
  - **指数平滑**（EMA）：对近期变化更敏感；
  - **线性回归**：捕捉上升/下降趋势。
    默认预测未来 5–10 个时间点，用于绘制趋势线。

所有分析结果以图表、仪表盘、文本建议等形式集成到 AnalyzerPage，形成闭环感知。

### 3.3 数据存储方案

鉴于项目为轻量级本地应用，**不引入数据库**，采用以下策略管理数据：

- **配置信息**：存储于 `config/settings.json`，包含 MQTT 连接参数、UI 刷新频率、分析阈值等，启动时加载，支持用户修改后保存。
- **运行时数据**：
  - 发布历史：内存列表，程序退出后不持久化（可选导出为 CSV）；
  - 订阅消息：环形缓冲区，仅保留最近 100 条；
  - 分析数据：滑动时间窗口（默认 30 秒），用于计算趋势与预测。

### 3.4 关键接口设计

#### 核心通信接口：MqttClient

位于 `core/mqtt_client.py`，封装 paho-mqtt 库，提供 PyQt 友好的异步接口：

- 信号：`connected`, `disconnected`, `message_received(topic, payload)`
- 方法：`connect()`, `publish()`, `subscribe()`, `is_connected()`
- 特性：支持 QoS 0/1/2、用户名密码认证、TLS 加密（8883 端口）

#### 模块调用接口规范

各页面通过标准方式调用逻辑层：

- **PublisherPage** → 创建 `PublisherLogic` 实例，连接 `published` 信号；
- **SubscriberPage** → 创建 `SubscriberLogic`，连接 `message_received` 信号，解析 payload 后驱动 LocationWidget 与 XiaojiaDisplay；
- **AnalyzerPage** → 组合使用 `ComfortModel`、`EventContext`、`Predictor`，定期（或消息到达时）更新分析结果。

接口设计遵循“逻辑与界面分离”原则，便于单元测试与团队协作。

# 4. 算法设计

### 4.1 消息发布模块



### 4.2 数据订阅模块


### 4.3 智能分析模块


## 5.4 运行指南

### 5.4.1 启动顺序

**必须按以下顺序启动：**

1. **启动 MQTT Broker** （如果未自启动）

```bash
# Windows
net start mosquitto

# macOS/Linux
mosquitto -c /usr/local/etc/mosquitto/mosquitto.conf
```

